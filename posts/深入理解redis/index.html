<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>一文理解和使用Redis | Erica-Blog</title>
<meta name=keywords content="技术"><meta name=description content="Redis 官网: https://redis.io/ 安装 Redis: https://github.com/tporadowski/redis/releases. 选择Redis-x64-5.0.14.1.msi即可 定义 Redis 是一个高性能 NoSQL, 用 C 实现, 可基于内存亦可持久化的 Key-Value 存储数据库, 并提"><meta name=author content="erica423"><link rel=canonical href=https://erica423.github.io/posts/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3redis/><link crossorigin=anonymous href=/assets/css/stylesheet.0fd2af49d7c8b1a279992ba82155f4ce3b1d94189758b3b0a99c8692cfdc0be9.css integrity rel="preload stylesheet" as=style><link rel=icon href=https://erica423.github.io/images/dls_icon.png><link rel=icon type=image/png sizes=16x16 href=https://erica423.github.io/images/dls_icon.png><link rel=icon type=image/png sizes=32x32 href=https://erica423.github.io/images/dls_icon.png><link rel=apple-touch-icon href=https://erica423.github.io/images/dls_icon.png><link rel=mask-icon href=https://erica423.github.io/images/dls_icon.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://erica423.github.io/posts/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3redis/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script>(function(){""&&prompt("请输入文章密码")!==""&&(alert("密码错误！"),history.back())})()</script><link rel=stylesheet href=https://s1.hdslb.com/bfs/static/jinkela/long/font/regular.css><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Nunito:ital,wght@0,200..1000;1,200..1000&display=swap" rel=stylesheet><script src=https://unpkg.com/@waline/client@v2/dist/waline.js></script><link rel=stylesheet href=https://unpkg.com/@waline/client@v2/dist/waline.css><meta property="og:title" content="一文理解和使用Redis"><meta property="og:description" content="Redis 官网: https://redis.io/ 安装 Redis: https://github.com/tporadowski/redis/releases. 选择Redis-x64-5.0.14.1.msi即可 定义 Redis 是一个高性能 NoSQL, 用 C 实现, 可基于内存亦可持久化的 Key-Value 存储数据库, 并提"><meta property="og:type" content="article"><meta property="og:url" content="https://erica423.github.io/posts/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3redis/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-11-01T15:39:00+08:00"><meta property="article:modified_time" content="2024-11-01T15:39:00+08:00"><meta property="og:site_name" content="erica-blog"><meta name=twitter:card content="summary"><meta name=twitter:title content="一文理解和使用Redis"><meta name=twitter:description content="Redis 官网: https://redis.io/ 安装 Redis: https://github.com/tporadowski/redis/releases. 选择Redis-x64-5.0.14.1.msi即可 定义 Redis 是一个高性能 NoSQL, 用 C 实现, 可基于内存亦可持久化的 Key-Value 存储数据库, 并提"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://erica423.github.io/posts/"},{"@type":"ListItem","position":2,"name":"一文理解和使用Redis","item":"https://erica423.github.io/posts/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3redis/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"一文理解和使用Redis","name":"一文理解和使用Redis","description":"Redis 官网: https://redis.io/ 安装 Redis: https://github.com/tporadowski/redis/releases. 选择Redis-x64-5.0.14.1.msi即可 定义 Redis 是一个高性能 NoSQL, 用 C 实现, 可基于内存亦可持久化的 Key-Value 存储数据库, 并提","keywords":["技术"],"articleBody":"Redis 官网: https://redis.io/\n安装 Redis: https://github.com/tporadowski/redis/releases. 选择Redis-x64-5.0.14.1.msi即可\n定义 Redis 是一个高性能 NoSQL, 用 C 实现, 可基于内存亦可持久化的 Key-Value 存储数据库, 并提供多种语言的 API。\n根据月度排行网站DB-Engines.com的数据，Redis 是现在最受欢迎的 NoSQL 数据库之一(MongoDB 亦为 NoSQL 数据库)。\n和MySQL的区别 关系型DB依赖于传统的表行列存储，非关系型DB依靠kv存储。 Redis不支持SQL语句。 与 MySQL 数据库不同的是(为了实现数据的持久化存储, Mysql 将数据存储到了磁盘中), Redis 的数据是存在内存中的。它的读写速度非常快。 Redis基本数据类型 Redis 有如 字符串(String)、列表(List)、集合(Set)、有序集合(ZSet/Sorted Set) 这样的基础数据类型。\n优势: 性能好、丰富的数据类型。\nRedis持久化 定义: 持久化是指将数据写入持久存储(durable storage), 如固态硬盘(SSD)。\n注: 即使有持久化机制，Redis也无法保证永远不丢失数据。\nRedis 提供了一系列选项。\nRDB(Redis Database): 在指定的时间间隔内创建数据集的快照来保存数据。 优势：隔一段时间保存一次，对性能影响小； 缺点：在两次保存间隔之间可能丢失数据。\nAOF(Append Only File): 记录服务器接收到的每一个写操作，并将这些操作追加到日志文件中。 优势：出现问题可以重放日志操作来重建db； 缺点：记录了每一个操作，影响性能。\n无持久化: 完全禁用 Redis 的持久化机制, 这意味着 Redis 只会在内存中存储数据。\nAOF + RDB 组合: 可以在同一个实例中同时启用 RDB 和 AOF 持久化。\n设置方法 在 redis 目录下, 找到redis.windows.conf即可。\nRDB 部分\n默认情况下, Redis 会将数据集的快照保存在磁盘上一个名为 dump.rdb的二进制文件中。\n目录(一般情况)\nC:\\Program Files\\Redis， 在redis.windows.conf文件内\n找到\n1 save 60 1000 AOF 部分\n找到 将no改为yes, 开启 AOF\n1 appendonly yes 它在我们的项目中的作用：\n计数器 （点赞、转发、评论数） Go-redis 定义: Go-redis 是 Golang 中用于与 Redis 交互的强大工具, 支持 Redis Server 的 Golang 客户端。\nGitHub: https://github.com/redis/go-redis\n文档: https://redis.uptrace.dev/zh/\n1 go get -u github.com/go-redis/redis config/redis.go\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 package config import ( \"github.com/go-redis/redis\" ) var RedisClient *redis.Client func InitRedis() { RedisClient = redis.NewClient(\u0026redis.Options{ Addr: \"localhost:6379\", DB: 0, // 默认数据库(use default DB) Password: \"\", }) _, err := RedisClient.Ping().Result() if err != nil { panic(\"Failed to connect to Redis\") } } localhost:6379——在安装过程中设置的端口。默认情况下就是 6379。\nglobal.go\n1 2 3 4 var ( DB *gorm.DB RedisDB *redis.Client ) 实现点赞功能 给文章增加点赞数，like_controller.go\nredis key 命名规范的设计 key 单词与单词之间以 (:)分割, 如user:userinfo, article:1:likes\nSET, INCR, DECR, GET命令 SET 命令用于设置给定 key 的值。\nINCR 将 key 中储存的数字值增一。若 key 不存在,那么 key 的值会先被初始化为 0,然后再执行操作。(0 -\u003e 1)\nDECR 则将 key 中储存的数字减一。\nGET 命令用于获取指定 key 的值。\nGo-redis活用:\n1 2 3 // 执行 Redis 命令: val, err := rdb.Get(\"key\").Result() // (*redis.Client).Get(key) fmt.Println(val) 重要概念: 原子性 原子性确保一个操作在执行过程中是不可被打断的。对于原子操作, 要么所有的步骤都成功完成并对外可见, 要么这些步骤都不执行, 系统的状态保持不变。\nINCR 和 DECR 操作在 Redis 中就是原子操作。\n例子: 用户 A 发起点赞请求, Redis 执行 INCR 命令, 将点赞数从 10 增加到 11。 用户 B 几乎同时发起点赞请求, Redis 执行 INCR 命令, 将点赞数从 11 增加到 12。\n因此, 若多个操作只是单纯的对数据进行增加或减少值, Redis 提供的INCR和DECR命令可以直接帮助我们进行并发控制。\n但是, 若多个操作不只是单纯的进行数据增减值, 还包括更复杂的操作, 如: 逻辑判断, 此时 Redis 的单命令操作无法保证多个操作互斥执行, 故可用 Lua 脚本来解决此问题。https://cloud.tencent.com/developer/article/1844723/\n路由部分最后配置 router.go\n1 2 api.POST(\"/articles/:id/likes\", controllers.LikeArticle) api.GET(\"/articles/:id/likes\", controllers.GetArticleLikes) 测试用: GET\n1 http://localhost:3000/api/articles/1/likes 可以看到, 正确地得到了 likes 为 0 的响应内容。\n优化 - Redis缓存 为何要有缓存技术? 减轻数据库访问压力, 加快请求响应速度。\n缓存读取速度比从数据库中读取快得多。亦可大幅减少数据库查询的次数, 提高应用程序的响应速度。\n案例: 文章预览页面, 若有非常多的文章内容(几千条内容), 且此项目用户量较大 若无缓存, 所有的请求都需要直接访问数据库,\n可能带来的风险: 应用程序响应变慢, 数据库容易被大量查询拖慢, 影响整个系统的稳定性。\n常见的缓存设计模式 旁路缓存模式(Cache-Aside 模式): 应用程序直接与缓存和数据库交互, 并负责管理缓存的内容。使用该模式的应用程序, 会同时操作缓存与数据库\n具体流程如下：\n先尝试从缓存中读取数据。若缓存命中, 直接返回缓存中的数据,\n若缓存未命中, 则从数据库中读取数据, 并将数据存入缓存中, 然后返回给客户端。\n代码逻辑:\n缓存未命中： 如果 Redis 中没有找到对应的缓存(缓存未命中), 代码会从数据库中获取文章数据。 获取到数据后, 代码将数据序列化为 JSON, 并将其存储在 Redis 缓存中, 同时设置一个过期时间。 最后, 返回数据库中的数据给客户端。 缓存命中： 如果缓存命中 (Redis 中找到了对应的缓存数据), 代码直接从缓存中获取数据。 然后, 将缓存中的数据反序列化为文章列表, 返回给客户端。 (在读取数据时, 只有在缓存未命中的情况下, 才会查询数据库并将结果写入缓存。)\n此外, 还有如读写穿透模式等等模式。\n解决下一个问题：\n若在缓存有效期内, 用户又新增了一些文章, 此时用户通过缓存得到文章, 将看不到变化。\n解决方法案例:\n常见的缓存失效策略 设置过期时间 (我们已经做过了)\n主动更新缓存 (如何保证数据库和缓存的数据一致性)\n如: 当新增文章时, 除了更新数据库, 还要同步更新或删除缓存中的对应数据。这样, 下一次读取时, 缓存中的数据就是最新的。\n或者新增文章时, 不直接更新缓存, 而是删除缓存中的旧数据。下次读取时, 由于缓存没有命中, 从数据库中读取最新数据并重新写入缓存。\nRedis DEL命令: 用于删除已存在的键。\n1 2 3 4 5 // 主动更新缓存 删除就缓存 if err := global.RedisDB.Del(cacheKey); err != nil { ctx.JSON(http.StatusInternalServerError, gin.H{\"error\": err.Error()}) return } CORS 跨域 CORS (Cross-Origin Resource Sharing), 全称为\"跨域 (跨源) 资源共享, 是一种机制, 使用额外的 HTTP 头来告诉浏览器允许一个网页从另一个域 (不同于该网页所在的域) 请求资源。这样可以在服务器和客户端之间进行安全的跨域通信。\n浏览器将 CORS 请求分成两类:\n简单请求 (simple req) 方法如GET, POST\n头部字段如: Accept, Accept-Language, Content-Language, Content-Type(需要注意额外的限制)等\n在 Postman 中检查 content-type 及 content-length\n非简单请求 (not-so-simple req) 方法如PUT\n在正式通信之前, 增加一次HTTP查询请求, 称为预检 (Preflight)请求。 该请求是Option方法的, 通过该请求来知道服务端是否允许跨域请求。\n对于简单请求, 浏览器直接发出 CORS 请求。\nCORS 相关的问题 域是什么?\nOrigin, 可译为源, 亦可译为域, 在 CORS 上下文中 Origin 由三个元素组成： Origin 即为 协议(如https) + 域名(如www.example.com) + 端口(如80) 同源策略(Same-Origin Policy, SOP)\n浏览器的一种安全机制, 用于防止恶意网站通过脚本对其他网站的内容进行访问。 以下 URL 属于同源地址：\n如: example.com:443 和 example.com:443/articles\n但inkkaplum频道B站.example.com/articles 和 example.com/articles则不是。\n自然, example.com:80和example.com:443则不是\n跨域请求\n指从一个域向另一个域发起的 HTTP 请求。(比如从80端口发送到443端口的请求)\n如从前端应用向不同的后端 API 服务器请求数据, 但是同源策略默认会阻止这些请求。\n所以需要 CORS 机制来显式允许跨域访问。\n本案例的 URL:\n(前端)http://localhost:5173 和(后端)http://localhost:3000\n浏览器默认允许同源请求, 但是默认会阻止这些跨域请求, 除非服务器明确允许。\n要解决这个问题, 需在后端应用中配置 CORS, 允许前端应用http://localhost:5173访问后端 API。\n安装 CORS 中间件 使用 Gin CORS middleware, 可以很方便地在 Gin 中配置 CORS。\n官方案例: https://github.com/gin-contrib/cors\n命令\n1 go get github.com/gin-contrib/cors 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 package main import ( \"time\" \"github.com/gin-contrib/cors\" \"github.com/gin-gonic/gin\" ) func main() { router := gin.Default() // CORS for https://foo.com and https://github.com origins, allowing: // - PUT and PATCH methods // - Origin header // - Credentials share // - Preflight requests cached for 12 hours router.Use(cors.New(cors.Config{ AllowOrigins: []string{\"https://....com\"}, AllowMethods: []string{\"PUT\", \"PATCH\"}, AllowHeaders: []string{\"Origin\"}, ExposeHeaders: []string{\"Content-Length\"}, AllowCredentials: true, AllowOriginFunc: func(origin string) bool { return origin == \"https://github.com\" }, MaxAge: 12 * time.Hour, })) router.Run() } 优雅地退出应用 我们目前可以看到\n1 exit status 0xc000013a 我们需要进行处理。\n参考此文档:\nhttps://gin-gonic.com/zh-cn/docs/examples/graceful-restart-or-stop/\nGo Channel Go 语言的并发模型是 CSP (Communicating Sequential Processes/译为通信顺序进程), 提倡 通过通信共享内存 而非通过共享内存而实现通信。也就是goroutine间的通信机制。\nChannel 类型: 通道在 Go 中是一种特殊的类型。\n通道像一个队列(Queue), 总是遵循先入先出(FIFO)的规则以保证收发数据的顺序。\n1 var channelExample chan int // 声明一个传递整型的通道 判断:\nchan T 双向chan类型的T\nchan\u003c- T 单向写入chan类型的T（只写）\n\u003c-chan T单向接收chan类型的T（只读）\n通道是引用类型, 故空值为nil。\n案例:\n1 2 var channelExample chan int fmt.Println(channelExample) //输出 声明的 Channel, 需用 make func 初始化之后才能使用。格式如下:\n1 2 3 make(chan 元素类型, [缓冲(Buffer)大小(可选)]) // 例子: channelExample01 := make(chan []int) 操作: 有发送(Send)、接收(Receive)和关闭(Close)三种操作。 发送的案例:\n1 2 var channelExample chan int channelExample \u003c- 114 // 会死锁 接收的案例\n1 2 example := \u003c- channelExample \u003c-channelExample 关闭的案例\n通过调用内置的 close func 来关闭 channel。\n1 close(channelExample) 关闭后的通道有如下特点:\n再发送值就会导致 panic。 对其进行接收会一直获取值直到通道为空。 对一个关闭的并且没有值的通道执行接收操作会得到对应类型的零值。 关闭一个已经关闭的通道会导致 panic。 判断 channel 是否关闭\n1 v, ok := \u003c-channel 死锁(Deadlock) 1 fatal error: all goroutines are asleep - deadlock! 第一种情形\n1 2 3 4 5 6 7 8 func main() { channel := make(chan int, 0) // 缓冲区大小为0 channel \u003c- 114 x := \u003c- channel fmt.Println(x) } 解决方法, 缓冲大小改变, 如channel := make(chan int, 1)\n但是:\n1 2 3 4 5 6 7 8 func main() { channel := make(chan int, 1) channel \u003c- 10 channel \u003c- 10 x:= \u003c- channel fmt.Println(x) // deadlock } 或者,\n1 2 3 4 5 6 7 8 9 10 func main() { channel := make(chan int, 0) go func(){ channel \u003c- 114 }() x := \u003c- channel fmt.Println(x) // 114 } 第二种情形\n1 2 3 4 5 6 7 8 func main() { channel := make(chan int) x := \u003c- channel go func() { channel \u003c-114 }() fmt.Println(x) // deadlock } 第三种情形\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 func main() { channel01 := make(chan int) channel02 := make(chan int) go func() { select { case \u003c- channel01: channel02\u003c-114 } }() select { case \u003c- channel02: channel01 \u003c- 114 } } // chan1 chan2都在等从对方读出东西 //结论: fatal error: all goroutines are asleep - deadlock! Select说明: select 是 Go 中的一个控制结构。\n官方文档关闭案例 https://gin-gonic.com/zh-cn/docs/examples/graceful-restart-or-stop/\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 // +build go1.8 package main import ( \"context\" \"log\" \"net/http\" \"os\" \"os/signal\" \"time\" \"github.com/gin-gonic/gin\" ) func main() { router := gin.Default() router.GET(\"/\", func(c *gin.Context) { time.Sleep(5 * time.Second) c.String(http.StatusOK, \"Welcome Gin Server\") }) srv := \u0026http.Server{ Addr: \":8080\", Handler: router, } go func() { if err := srv.ListenAndServe(); err != nil \u0026\u0026 err != http.ErrServerClosed { log.Fatalf(\"listen: %s\\n\", err) } }() quit := make(chan os.Signal, 1) signal.Notify(quit, os.Interrupt) \u003c-quit log.Println(\"Shutdown Server ...\") ctx, cancel := context.WithTimeout(context.Background(), 5*time.Second) defer cancel() if err := srv.Shutdown(ctx); err != nil { log.Fatal(\"Server Shutdown:\", err) } log.Println(\"Server exiting\") } 然后即可看到改变:\n1 2 2024/08/30 23:34:22 Shutdown Server... 2024/08/30 23:34:22 Server exiting sync.WaitGroup WaitGroup是sync package 中的一个struct, 用来收集需要等待执行完成的goroutine。\n三个方法:\nAdd(): 用来设置或添加要等待完成的 goroutine 数量 例子:\nAdd(2)或两次调用Add(1)都会设置等待计数器的值为 2, 即为要等待 2 个 goroutine 完成。\n自然, Done()则表示需要等待的 goroutine 在真正完成之前, 应调用该方法来人为表示 goroutine 完成了, 重要地是: 该方法会对等待计数器减 1。\n最后, Wait()则意味着在等待计数器减为 0 之前, Wait()会一直阻塞当前的 goroutine\n案例代码:\n1 2 3 4 5 6 7 8 9 10 11 12 13 func TestTaskControdl(t *testing.T) { taskNum := 5 wg := sync.WaitGroup{} wg.Add(taskNum) for i := 0; i \u003c taskNum; i ++ { go func(i int) { defer wg.Done() fmt.Println(\"info\", i) }(i) } wg.Wait() } 结论：\n1 2 3 4 5 info 4 info 3 info 1 info 0 info 2 Close案例 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 func Test(t *testing.T){ test := make(chan int, 10) go func(info chan int){ for{ select{ case val, ok := \u003c- test: if !ok{ t.Logf(\"Channel Closed!\") return } t.Logf(\"data %d\\n\", val) } } }(test) go func(){ test \u003c- 1 time.Sleep(1 * time.Second) test \u003c- 2 close(test) }() time.Sleep(5 *time.Second) } 输出\n1 2 3 data 1 data 2 Context Closed! 单独退出通道 传输数据不共用一个 channel\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 func TestA(t *testing.T) { test := make(chan int, 5) exit := make(chan struct{}) go func(info chan int, exit chan struct{}) { for { select { case val := \u003c-info: t.Logf(\"data %d\\n\", val) case \u003c-exit: t.Logf(\"Task Exit!!\\n\") return } } }(test, exit) go func() { test \u003c- 1 time.Sleep(1 * time.Second) test \u003c- 2 close(exit) }() time.Sleep(5 *time.Second) } 超时任务控制 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 func Test(t *testing.T){ test := make(chan int, 5) go func(info chan int){ for{ select{ case val := \u003c- info: t.Logf(\"Data %d\\n\", val) case \u003c- time.After(2 * time.Second): t.Logf(\"Time out!\\n\") return } } }(test) go func(){ test \u003c- 1 time.Sleep(2 * time.Second) //\u003e=2 test \u003c- 2 }() time.Sleep(5 *time.Second) } 结论:\n1 2 main_test.go:98: Data 1 main_test.go:101: Time out! Context 的场景 ","wordCount":"4821","inLanguage":"en","datePublished":"2024-11-01T15:39:00+08:00","dateModified":"2024-11-01T15:39:00+08:00","author":{"@type":"Person","name":"erica423"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://erica423.github.io/posts/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3redis/"},"publisher":{"@type":"Organization","name":"Erica-Blog","logo":{"@type":"ImageObject","url":"https://erica423.github.io/images/dls_icon.png"}}}</script><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><meta name=referrer content="no-referrer-when-downgrade"></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://erica423.github.io/ accesskey=h title="Home (Alt + H)"><img src=https://erica423.github.io/images/dls_icon.png alt aria-label=logo height=25>Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://erica423.github.io/archives/ title=🎮动态><span>🎮动态</span></a></li><li><a href=https://erica423.github.io/tags/ title=🎲标签><span>🎲标签</span></a></li><li><a href=https://erica423.github.io/search/ title="🎯搜索 (Alt + /)" accesskey=/><span>🎯搜索</span></a></li><li><a href=https://github.com/Erica423/Erica423.github.io/ title=Github><span>Github</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://erica423.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://erica423.github.io/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">一文理解和使用Redis</h1><div class=post-meta><span title='2024-11-01 15:39:00 +0800 +0800'>November 1, 2024</span>&nbsp;·&nbsp;erica423&nbsp;|&nbsp;<a href=https://github.com/Erica423/Erica423.github.io rel="noopener noreferrer" target=_blank>主页</a><div class=meta-item>&nbsp·&nbsp
	      <span id=busuanzi_container_page_pv>本文阅读量<span id=busuanzi_value_page_pv></span>次</span></div></div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#定义>定义</a></li><li><a href=#和mysql的区别>和MySQL的区别</a></li><li><a href=#redis基本数据类型>Redis基本数据类型</a></li><li><a href=#redis持久化>Redis持久化</a><ul><li><a href=#设置方法>设置方法</a></li></ul></li><li><a href=#go-redis>Go-redis</a></li><li><a href=#实现点赞功能>实现点赞功能</a><ul><li><a href=#redis-key-命名规范的设计>redis key 命名规范的设计</a></li><li><a href=#set-incr-decr-get命令>SET, INCR, DECR, GET命令</a></li><li><a href=#重要概念-原子性>重要概念: 原子性</a></li><li><a href=#路由部分最后配置>路由部分最后配置</a></li></ul></li><li><a href=#优化---redis缓存>优化 - Redis缓存</a><ul><li><a href=#常见的缓存设计模式>常见的缓存设计模式</a></li><li><a href=#常见的缓存失效策略>常见的缓存失效策略</a></li></ul></li><li><a href=#cors-跨域>CORS 跨域</a><ul><li><a href=#cors-相关的问题>CORS 相关的问题</a></li></ul></li><li><a href=#优雅地退出应用>优雅地退出应用</a><ul><li><a href=#go-channel>Go Channel</a></li><li><a href=#死锁deadlock>死锁(Deadlock)</a></li><li><a href=#syncwaitgroup>sync.WaitGroup</a></li></ul></li></ul></nav></div></details></div><div class=post-content><p>Redis 官网: <a href=https://redis.io/>https://redis.io/</a></p><p>安装 Redis: <a href=https://github.com/tporadowski/redis/releases>https://github.com/tporadowski/redis/releases</a>.
选择<code>Redis-x64-5.0.14.1.msi</code>即可</p><h2 id=定义>定义<a hidden class=anchor aria-hidden=true href=#定义>#</a></h2><p>Redis 是一个高性能 NoSQL, 用 C 实现, 可基于内存亦可持久化的 Key-Value 存储数据库, 并提供多种语言的 API。</p><p>根据月度排行网站<code>DB-Engines.com</code>的数据，Redis 是现在最受欢迎的 NoSQL 数据库之一(MongoDB 亦为 NoSQL 数据库)。</p><h2 id=和mysql的区别>和MySQL的区别<a hidden class=anchor aria-hidden=true href=#和mysql的区别>#</a></h2><ul><li>关系型DB依赖于传统的表行列存储，非关系型DB依靠kv存储。</li><li>Redis不支持SQL语句。</li><li>与 MySQL 数据库不同的是(为了实现数据的持久化存储, Mysql 将数据存储到了磁盘中), Redis 的数据是存在内存中的。它的读写速度非常快。</li></ul><h2 id=redis基本数据类型>Redis基本数据类型<a hidden class=anchor aria-hidden=true href=#redis基本数据类型>#</a></h2><p>Redis 有如 字符串(String)、列表(List)、集合(Set)、有序集合(ZSet/Sorted Set) 这样的基础数据类型。</p><p>优势: 性能好、丰富的数据类型。</p><h2 id=redis持久化>Redis持久化<a hidden class=anchor aria-hidden=true href=#redis持久化>#</a></h2><p>定义: 持久化是指将数据写入持久存储(durable storage), 如固态硬盘(SSD)。</p><blockquote><p>注: 即使有持久化机制，Redis也无法保证永远不丢失数据。</p></blockquote><p>Redis 提供了一系列选项。</p><ol><li><p><strong>RDB</strong>(Redis Database): 在指定的时间间隔内创建数据集的快照来保存数据。
优势：隔一段时间保存一次，对性能影响小； 缺点：在两次保存间隔之间可能丢失数据。</p></li><li><p><strong>AOF</strong>(Append Only File): 记录服务器接收到的每一个写操作，并将这些操作追加到日志文件中。
优势：出现问题可以重放日志操作来重建db； 缺点：记录了每一个操作，影响性能。</p></li><li><p>无持久化: 完全禁用 Redis 的持久化机制, 这意味着 Redis 只会在内存中存储数据。</p></li><li><p>AOF + RDB 组合: 可以在同一个实例中同时启用 RDB 和 AOF 持久化。</p></li></ol><h3 id=设置方法>设置方法<a hidden class=anchor aria-hidden=true href=#设置方法>#</a></h3><p>在 redis 目录下, 找到<code>redis.windows.conf</code>即可。</p><p>RDB 部分</p><p>默认情况下, Redis 会将数据集的快照保存在磁盘上一个名为 <code>dump.rdb</code>的二进制文件中。</p><p>目录(一般情况)</p><p><code>C:\Program Files\Redis</code>， 在<code>redis.windows.conf</code>文件内</p><p>找到</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>save 60 1000
</span></span></code></pre></td></tr></table></div></div><p>AOF 部分</p><p>找到 将<code>no</code>改为<code>yes</code>, 开启 AOF</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>appendonly yes
</span></span></code></pre></td></tr></table></div></div><p>它在我们的项目中的作用：</p><ul><li>计数器 （点赞、转发、评论数）</li></ul><h2 id=go-redis>Go-redis<a hidden class=anchor aria-hidden=true href=#go-redis>#</a></h2><p>定义: Go-redis 是 Golang 中用于与 Redis 交互的强大工具, 支持 Redis Server 的 Golang 客户端。</p><p>GitHub: <a href=https://github.com/redis/go-redis>https://github.com/redis/go-redis</a></p><p>文档: <a href=https://redis.uptrace.dev/zh/>https://redis.uptrace.dev/zh/</a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>go get -u github.com/go-redis/redis
</span></span></code></pre></td></tr></table></div></div><p><code>config/redis.go</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>config</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/go-redis/redis&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>RedisClient</span> <span class=o>*</span><span class=nx>redis</span><span class=p>.</span><span class=nx>Client</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>InitRedis</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>RedisClient</span> <span class=p>=</span> <span class=nx>redis</span><span class=p>.</span><span class=nf>NewClient</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>redis</span><span class=p>.</span><span class=nx>Options</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>Addr</span><span class=p>:</span> <span class=s>&#34;localhost:6379&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>DB</span><span class=p>:</span>   <span class=mi>0</span><span class=p>,</span>  <span class=c1>// 默认数据库(use default DB)
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>Password</span><span class=p>:</span> <span class=s>&#34;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>RedisClient</span><span class=p>.</span><span class=nf>Ping</span><span class=p>().</span><span class=nf>Result</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nb>panic</span><span class=p>(</span><span class=s>&#34;Failed to connect to Redis&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><code>localhost:6379</code>——在安装过程中设置的端口。默认情况下就是 6379。</p><p><code>global.go</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>var</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>DB</span> <span class=o>*</span><span class=nx>gorm</span><span class=p>.</span><span class=nx>DB</span>
</span></span><span class=line><span class=cl>    <span class=nx>RedisDB</span> <span class=o>*</span><span class=nx>redis</span><span class=p>.</span><span class=nx>Client</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=实现点赞功能>实现点赞功能<a hidden class=anchor aria-hidden=true href=#实现点赞功能>#</a></h2><p>给文章增加点赞数，<code>like_controller.go</code></p><h3 id=redis-key-命名规范的设计>redis key 命名规范的设计<a hidden class=anchor aria-hidden=true href=#redis-key-命名规范的设计>#</a></h3><p>key 单词与单词之间以 (:)分割, 如<code>user:userinfo</code>, <code>article:1:likes</code></p><h3 id=set-incr-decr-get命令>SET, INCR, DECR, GET命令<a hidden class=anchor aria-hidden=true href=#set-incr-decr-get命令>#</a></h3><p><code>SET</code> 命令用于设置给定 key 的值。</p><p><code>INCR</code> 将 key 中储存的数字值增一。若 key 不存在,那么 key 的值会先被初始化为 0,然后再执行操作。(<code>0</code> -> <code>1</code>)</p><p><code>DECR</code> 则将 key 中储存的数字减一。</p><p><code>GET</code> 命令用于获取指定 key 的值。</p><p>Go-redis活用:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// 执行 Redis 命令:
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>val</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>rdb</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=s>&#34;key&#34;</span><span class=p>).</span><span class=nf>Result</span><span class=p>()</span> <span class=c1>// (*redis.Client).Get(key)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>val</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=重要概念-原子性>重要概念: 原子性<a hidden class=anchor aria-hidden=true href=#重要概念-原子性>#</a></h3><p>原子性确保一个操作在执行过程中是不可被打断的。对于原子操作, 要么所有的步骤都成功完成并对外可见, 要么这些步骤都不执行, 系统的状态保持不变。</p><p><code>INCR</code> 和 <code>DECR</code> 操作在 Redis 中就是原子操作。</p><p>例子: 用户 A 发起点赞请求, Redis 执行 <code>INCR</code> 命令, 将点赞数从 10 增加到 11。
用户 B 几乎同时发起点赞请求, Redis 执行 <code>INCR</code> 命令, 将点赞数从 11 增加到 12。</p><p>因此, 若多个操作只是单纯的对数据进行增加或减少值, Redis 提供的<code>INCR</code>和<code>DECR</code>命令可以直接帮助我们进行<code>并发控制</code>。</p><p>但是, 若多个操作不只是单纯的进行数据增减值, 还包括更复杂的操作, 如: 逻辑判断, 此时 Redis 的单命令操作无法保证多个操作互斥执行, 故可用 <code>Lua 脚本</code>来解决此问题。<a href=https://cloud.tencent.com/developer/article/1844723/>https://cloud.tencent.com/developer/article/1844723/</a></p><h3 id=路由部分最后配置>路由部分最后配置<a hidden class=anchor aria-hidden=true href=#路由部分最后配置>#</a></h3><p><code>router.go</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>api</span><span class=p>.</span><span class=nf>POST</span><span class=p>(</span><span class=s>&#34;/articles/:id/likes&#34;</span><span class=p>,</span> <span class=nx>controllers</span><span class=p>.</span><span class=nx>LikeArticle</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>api</span><span class=p>.</span><span class=nf>GET</span><span class=p>(</span><span class=s>&#34;/articles/:id/likes&#34;</span><span class=p>,</span> <span class=nx>controllers</span><span class=p>.</span><span class=nx>GetArticleLikes</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>测试用: <code>GET</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>http://localhost:3000/api/articles/1/likes
</span></span></code></pre></td></tr></table></div></div><p>可以看到, 正确地得到了 likes 为 0 的响应内容。</p><h2 id=优化---redis缓存>优化 - Redis缓存<a hidden class=anchor aria-hidden=true href=#优化---redis缓存>#</a></h2><ul><li>为何要有缓存技术?</li></ul><p>减轻数据库访问压力, 加快请求响应速度。</p><p>缓存读取速度比从数据库中读取快得多。亦可大幅减少数据库查询的次数, 提高应用程序的响应速度。</p><ul><li>案例:</li></ul><p>文章预览页面, 若有非常多的文章内容(几千条内容), 且此项目用户量较大
若无缓存, 所有的请求都需要直接访问数据库,</p><p>可能带来的风险: 应用程序响应变慢, 数据库容易被大量查询拖慢, 影响整个系统的稳定性。</p><h3 id=常见的缓存设计模式>常见的缓存设计模式<a hidden class=anchor aria-hidden=true href=#常见的缓存设计模式>#</a></h3><ol><li><strong>旁路缓存模式</strong>(<strong>Cache-Aside 模式</strong>):</li></ol><p>应用程序直接与缓存和数据库交互, 并负责管理缓存的内容。使用该模式的应用程序, 会同时操作缓存与数据库</p><p>具体流程如下：</p><ul><li><p>先尝试从缓存中读取数据。若缓存命中, 直接返回缓存中的数据,</p></li><li><p>若缓存未命中, 则从数据库中读取数据, 并将数据存入缓存中, 然后返回给客户端。</p></li></ul><p>代码逻辑:</p><ol><li><strong>缓存未命中</strong>：</li></ol><ul><li>如果 Redis 中没有找到对应的缓存(缓存未命中), 代码会从数据库中获取文章数据。</li><li>获取到数据后, 代码将数据序列化为 JSON, 并将其存储在 Redis 缓存中, 同时设置一个过期时间。</li><li>最后, 返回数据库中的数据给客户端。</li></ul><ol start=2><li><strong>缓存命中</strong>：</li></ol><ul><li>如果缓存命中 (Redis 中找到了对应的缓存数据), 代码直接从缓存中获取数据。</li><li>然后, 将缓存中的数据<strong>反序列化</strong>为文章列表, 返回给客户端。</li></ul><p>(在读取数据时, 只有在缓存未命中的情况下, 才会查询数据库并将结果写入缓存。)</p><p>此外, 还有如<strong>读写穿透模式</strong>等等模式。</p><hr><p>解决下一个问题：</p><p>若在缓存有效期内, 用户又新增了一些文章, 此时用户通过缓存得到文章, 将看不到变化。</p><p>解决方法案例:</p><h3 id=常见的缓存失效策略>常见的缓存失效策略<a hidden class=anchor aria-hidden=true href=#常见的缓存失效策略>#</a></h3><ol><li><p>设置过期时间 (我们已经做过了)</p></li><li><p>主动更新缓存 (如何保证数据库和缓存的数据一致性)</p><blockquote><p>如: 当新增文章时, 除了更新数据库, 还要同步更新或删除缓存中的对应数据。这样, 下一次读取时, 缓存中的数据就是最新的。</p><p>或者新增文章时, 不直接更新缓存, 而是删除缓存中的旧数据。下次读取时, 由于缓存没有命中, 从数据库中读取最新数据并重新写入缓存。</p></blockquote></li></ol><p>Redis <code>DEL</code>命令: 用于删除已存在的键。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// 主动更新缓存 删除就缓存
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>global</span><span class=p>.</span><span class=nx>RedisDB</span><span class=p>.</span><span class=nf>Del</span><span class=p>(</span><span class=nx>cacheKey</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>ctx</span><span class=p>.</span><span class=nf>JSON</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusInternalServerError</span><span class=p>,</span> <span class=nx>gin</span><span class=p>.</span><span class=nx>H</span><span class=p>{</span><span class=s>&#34;error&#34;</span><span class=p>:</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>()})</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=cors-跨域>CORS 跨域<a hidden class=anchor aria-hidden=true href=#cors-跨域>#</a></h2><p>CORS (Cross-Origin Resource Sharing), 全称为"跨域 (跨源) 资源共享, 是一种机制, 使用额外的 HTTP 头来告诉浏览器允许一个网页从另一个域 (不同于该网页所在的域) 请求资源。这样可以在服务器和客户端之间进行安全的跨域通信。</p><p>浏览器将 CORS 请求分成两类:</p><ul><li>简单请求 (simple req)</li></ul><p>方法如<code>GET</code>, <code>POST</code></p><p>头部字段如: <code>Accept</code>, <code>Accept-Language</code>, <code>Content-Language</code>, <code>Content-Type</code>(需要注意额外的限制)等</p><p>在 Postman 中检查 <code>content-type</code> 及 <code>content-length</code></p><ul><li>非简单请求 (not-so-simple req)</li></ul><p>方法如<code>PUT</code></p><p>在正式通信之前, 增加一次<code>HTTP</code>查询请求, 称为<code>预检 (Preflight)</code>请求。
该请求是<code>Option</code>方法的, 通过该请求来知道服务端是否允许跨域请求。</p><p>对于简单请求, 浏览器直接发出 CORS 请求。</p><h3 id=cors-相关的问题>CORS 相关的问题<a hidden class=anchor aria-hidden=true href=#cors-相关的问题>#</a></h3><p>域是什么?</p><ul><li>Origin, 可译为源, 亦可译为域, 在 CORS 上下文中 Origin 由三个元素组成：</li><li>Origin 即为 <code>协议(如https)</code> + <code>域名(如www.example.com)</code> + <code>端口(如80)</code></li></ul><p>同源策略(Same-Origin Policy, SOP)</p><ul><li>浏览器的一种安全机制, 用于防止恶意网站通过脚本对其他网站的内容进行访问。</li></ul><p>以下 URL 属于同源地址：</p><ul><li><p>如: <code>example.com:443</code> 和 <code>example.com:443/articles</code></p></li><li><p>但<code>inkkaplum频道B站.example.com/articles</code> 和 <code>example.com/articles</code>则不是。</p></li><li><p>自然, <code>example.com:80</code>和<code>example.com:443</code>则不是</p></li></ul><p>跨域请求</p><ul><li><p>指从一个域向另一个域发起的 HTTP 请求。(比如从80端口发送到443端口的请求)</p></li><li><p>如从前端应用向不同的后端 API 服务器请求数据, 但是同源策略默认会阻止这些请求。</p></li></ul><p><strong>所以需要 CORS 机制来显式允许跨域访问。</strong></p><p>本案例的 URL:</p><p>(前端)<a href=http://localhost:5173>http://localhost:5173</a> 和(后端)<a href=http://localhost:3000>http://localhost:3000</a></p><p>浏览器默认允许同源请求, 但是默认会阻止这些跨域请求, 除非服务器明确允许。</p><p>要解决这个问题, 需在后端应用中配置 CORS, 允许前端应用<a href=http://localhost:5173>http://localhost:5173</a>访问后端 API。</p><h4 id=安装-cors-中间件>安装 CORS 中间件<a hidden class=anchor aria-hidden=true href=#安装-cors-中间件>#</a></h4><p>使用 <code>Gin CORS middleware</code>, 可以很方便地在 Gin 中配置 CORS。</p><p>官方案例: <a href=https://github.com/gin-contrib/cors>https://github.com/gin-contrib/cors</a></p><p>命令</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>go get github.com/gin-contrib/cors
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=s>&#34;time&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=s>&#34;github.com/gin-contrib/cors&#34;</span>
</span></span><span class=line><span class=cl>  <span class=s>&#34;github.com/gin-gonic/gin&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>router</span> <span class=o>:=</span> <span class=nx>gin</span><span class=p>.</span><span class=nf>Default</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=c1>// CORS for https://foo.com and https://github.com origins, allowing:
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// - PUT and PATCH methods
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// - Origin header
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// - Credentials share
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// - Preflight requests cached for 12 hours
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>router</span><span class=p>.</span><span class=nf>Use</span><span class=p>(</span><span class=nx>cors</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=nx>cors</span><span class=p>.</span><span class=nx>Config</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>AllowOrigins</span><span class=p>:</span>     <span class=p>[]</span><span class=kt>string</span><span class=p>{</span><span class=s>&#34;https://....com&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nx>AllowMethods</span><span class=p>:</span>     <span class=p>[]</span><span class=kt>string</span><span class=p>{</span><span class=s>&#34;PUT&#34;</span><span class=p>,</span> <span class=s>&#34;PATCH&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nx>AllowHeaders</span><span class=p>:</span>     <span class=p>[]</span><span class=kt>string</span><span class=p>{</span><span class=s>&#34;Origin&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nx>ExposeHeaders</span><span class=p>:</span>    <span class=p>[]</span><span class=kt>string</span><span class=p>{</span><span class=s>&#34;Content-Length&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nx>AllowCredentials</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>AllowOriginFunc</span><span class=p>:</span> <span class=kd>func</span><span class=p>(</span><span class=nx>origin</span> <span class=kt>string</span><span class=p>)</span> <span class=kt>bool</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>origin</span> <span class=o>==</span> <span class=s>&#34;https://github.com&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nx>MaxAge</span><span class=p>:</span> <span class=mi>12</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Hour</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>}))</span>
</span></span><span class=line><span class=cl>  <span class=nx>router</span><span class=p>.</span><span class=nf>Run</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=优雅地退出应用>优雅地退出应用<a hidden class=anchor aria-hidden=true href=#优雅地退出应用>#</a></h2><p>我们目前可以看到</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>exit</span> status 0xc000013a
</span></span></code></pre></td></tr></table></div></div><p>我们需要进行处理。</p><p>参考此文档:</p><p><a href=https://gin-gonic.com/zh-cn/docs/examples/graceful-restart-or-stop/>https://gin-gonic.com/zh-cn/docs/examples/graceful-restart-or-stop/</a></p><h3 id=go-channel>Go Channel<a hidden class=anchor aria-hidden=true href=#go-channel>#</a></h3><p>Go 语言的并发模型是 CSP (Communicating Sequential Processes/译为通信顺序进程), 提倡 <strong>通过通信共享内存</strong> 而非通过共享内存而实现通信。也就是goroutine间的通信机制。</p><p>Channel 类型: 通道在 Go 中是一种特殊的类型。</p><p>通道像一个队列(Queue), 总是遵循先入先出(FIFO)的规则以保证收发数据的顺序。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>var</span> <span class=nx>channelExample</span> <span class=kd>chan</span> <span class=kt>int</span>   <span class=c1>// 声明一个传递整型的通道
</span></span></span></code></pre></td></tr></table></div></div><p>判断:</p><p><code>chan T</code> 双向chan类型的T</p><p><code>chan&lt;- T</code> 单向写入chan类型的T（只写）</p><p><code>&lt;-chan T</code>单向接收chan类型的T（只读）</p><p>通道是引用类型, 故空值为<code>nil</code>。</p><p>案例:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>var</span> <span class=nx>channelExample</span> <span class=kd>chan</span> <span class=kt>int</span>
</span></span><span class=line><span class=cl><span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>channelExample</span><span class=p>)</span> <span class=c1>//输出&lt;nil&gt;
</span></span></span></code></pre></td></tr></table></div></div><p>声明的 Channel, 需用 make func 初始化之后才能使用。格式如下:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl>    <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=nx>元素类型</span><span class=p>,</span> <span class=p>[</span><span class=nx>缓冲</span><span class=p>(</span><span class=nx>Buffer</span><span class=p>)</span><span class=nx>大小</span><span class=p>(</span><span class=nx>可选</span><span class=p>)])</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 例子:
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>channelExample01</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=p>[]</span><span class=kt>int</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>操作: 有发送(Send)、接收(Receive)和关闭(Close)三种操作。</li></ul><p>发送的案例:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>var</span> <span class=nx>channelExample</span> <span class=kd>chan</span> <span class=kt>int</span>
</span></span><span class=line><span class=cl><span class=nx>channelExample</span> <span class=o>&lt;-</span> <span class=mi>114</span>  <span class=c1>// 会死锁
</span></span></span></code></pre></td></tr></table></div></div><p>接收的案例</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>example</span> <span class=o>:=</span> <span class=o>&lt;-</span> <span class=nx>channelExample</span>
</span></span><span class=line><span class=cl><span class=o>&lt;-</span><span class=nx>channelExample</span>
</span></span></code></pre></td></tr></table></div></div><p>关闭的案例</p><p>通过调用内置的 <code>close</code> func 来关闭 channel。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nb>close</span><span class=p>(</span><span class=nx>channelExample</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>关闭后的通道有如下特点:</p><ul><li>再发送值就会导致 panic。</li><li>对其进行接收会一直获取值直到通道为空。</li><li>对一个关闭的并且没有值的通道执行接收操作会得到对应类型的零值。</li><li>关闭一个已经关闭的通道会导致 panic。</li></ul><p>判断 channel 是否关闭</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>v</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=o>&lt;-</span><span class=nx>channel</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=死锁deadlock>死锁(Deadlock)<a hidden class=anchor aria-hidden=true href=#死锁deadlock>#</a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>fatal error: all goroutines are asleep - deadlock!
</span></span></code></pre></td></tr></table></div></div><p>第一种情形</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>channel</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kt>int</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>  <span class=c1>// 缓冲区大小为0
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=nx>channel</span> <span class=o>&lt;-</span> <span class=mi>114</span>
</span></span><span class=line><span class=cl>    <span class=nx>x</span> <span class=o>:=</span> <span class=o>&lt;-</span> <span class=nx>channel</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>解决方法, 缓冲大小改变, 如<code>channel := make(chan int, 1)</code></p><p>但是:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl>   <span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=nx>channel</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kt>int</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>       <span class=nx>channel</span> <span class=o>&lt;-</span> <span class=mi>10</span>
</span></span><span class=line><span class=cl>       <span class=nx>channel</span> <span class=o>&lt;-</span> <span class=mi>10</span>
</span></span><span class=line><span class=cl>       <span class=nx>x</span><span class=o>:=</span> <span class=o>&lt;-</span> <span class=nx>channel</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>       <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>x</span><span class=p>)</span>  <span class=c1>// deadlock
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>或者,</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>channel</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kt>int</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>go</span> <span class=kd>func</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>        <span class=nx>channel</span> <span class=o>&lt;-</span> <span class=mi>114</span>
</span></span><span class=line><span class=cl>    <span class=p>}()</span>
</span></span><span class=line><span class=cl>    <span class=nx>x</span> <span class=o>:=</span> <span class=o>&lt;-</span> <span class=nx>channel</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>x</span><span class=p>)</span>  <span class=c1>// 114
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>第二种情形</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>channel</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kt>int</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>x</span> <span class=o>:=</span> <span class=o>&lt;-</span> <span class=nx>channel</span>
</span></span><span class=line><span class=cl>    <span class=k>go</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>channel</span> <span class=o>&lt;-</span><span class=mi>114</span>
</span></span><span class=line><span class=cl>    <span class=p>}()</span>
</span></span><span class=line><span class=cl>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>x</span><span class=p>)</span>  <span class=c1>// deadlock
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>第三种情形</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>channel01</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kt>int</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>channel02</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kt>int</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>go</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>select</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=o>&lt;-</span> <span class=nx>channel01</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nx>channel02</span><span class=o>&lt;-</span><span class=mi>114</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>select</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=o>&lt;-</span> <span class=nx>channel02</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nx>channel01</span> <span class=o>&lt;-</span> <span class=mi>114</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// chan1 chan2都在等从对方读出东西
</span></span></span><span class=line><span class=cl><span class=c1>//结论: fatal error: all goroutines are asleep - deadlock!
</span></span></span></code></pre></td></tr></table></div></div><p><code>Select</code>说明:
select 是 Go 中的一个控制结构。</p><h4 id=官方文档关闭案例>官方文档关闭案例<a hidden class=anchor aria-hidden=true href=#官方文档关闭案例>#</a></h4><p><a href=https://gin-gonic.com/zh-cn/docs/examples/graceful-restart-or-stop/>https://gin-gonic.com/zh-cn/docs/examples/graceful-restart-or-stop/</a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// +build go1.8
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl> <span class=s>&#34;context&#34;</span>
</span></span><span class=line><span class=cl> <span class=s>&#34;log&#34;</span>
</span></span><span class=line><span class=cl> <span class=s>&#34;net/http&#34;</span>
</span></span><span class=line><span class=cl> <span class=s>&#34;os&#34;</span>
</span></span><span class=line><span class=cl> <span class=s>&#34;os/signal&#34;</span>
</span></span><span class=line><span class=cl> <span class=s>&#34;time&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=s>&#34;github.com/gin-gonic/gin&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=nx>router</span> <span class=o>:=</span> <span class=nx>gin</span><span class=p>.</span><span class=nf>Default</span><span class=p>()</span>
</span></span><span class=line><span class=cl> <span class=nx>router</span><span class=p>.</span><span class=nf>GET</span><span class=p>(</span><span class=s>&#34;/&#34;</span><span class=p>,</span> <span class=kd>func</span><span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=nx>time</span><span class=p>.</span><span class=nf>Sleep</span><span class=p>(</span><span class=mi>5</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=nx>c</span><span class=p>.</span><span class=nf>String</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusOK</span><span class=p>,</span> <span class=s>&#34;Welcome Gin Server&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=nx>srv</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>http</span><span class=p>.</span><span class=nx>Server</span><span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=nx>Addr</span><span class=p>:</span>    <span class=s>&#34;:8080&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=nx>Handler</span><span class=p>:</span> <span class=nx>router</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=k>go</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>srv</span><span class=p>.</span><span class=nf>ListenAndServe</span><span class=p>();</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=o>&amp;&amp;</span> <span class=nx>err</span> <span class=o>!=</span> <span class=nx>http</span><span class=p>.</span><span class=nx>ErrServerClosed</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;listen: %s\n&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>quit</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=nx>os</span><span class=p>.</span><span class=nx>Signal</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>signal</span><span class=p>.</span><span class=nf>Notify</span><span class=p>(</span><span class=nx>quit</span><span class=p>,</span> <span class=nx>os</span><span class=p>.</span><span class=nx>Interrupt</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&lt;-</span><span class=nx>quit</span>
</span></span><span class=line><span class=cl><span class=nx>log</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;Shutdown Server ...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>ctx</span><span class=p>,</span> <span class=nx>cancel</span> <span class=o>:=</span> <span class=nx>context</span><span class=p>.</span><span class=nf>WithTimeout</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>(),</span> <span class=mi>5</span><span class=o>*</span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>defer</span> <span class=nf>cancel</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>srv</span><span class=p>.</span><span class=nf>Shutdown</span><span class=p>(</span><span class=nx>ctx</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=s>&#34;Server Shutdown:&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nx>log</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;Server exiting&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>然后即可看到改变:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>2024/08/30 23:34:22 Shutdown Server...
</span></span><span class=line><span class=cl>2024/08/30 23:34:22 Server exiting
</span></span></code></pre></td></tr></table></div></div><h3 id=syncwaitgroup>sync.WaitGroup<a hidden class=anchor aria-hidden=true href=#syncwaitgroup>#</a></h3><p><code>WaitGroup</code>是<code>sync</code> package 中的一个<code>struct</code>, 用来收集需要等待执行完成的<code>goroutine</code>。</p><p>三个方法:</p><p><code>Add()</code>: 用来设置或添加要等待完成的 goroutine 数量
例子:</p><p><code>Add(2)</code>或两次调用<code>Add(1)</code>都会设置等待计数器的值为 2, 即为要等待 2 个 goroutine 完成。</p><p>自然, <code>Done()</code>则表示需要等待的 goroutine 在真正完成之前, 应调用该方法来人为表示 goroutine 完成了, 重要地是: 该方法会对等待计数器减 1。</p><p>最后, <code>Wait()</code>则意味着在等待计数器减为 0 之前, <code>Wait()</code>会一直阻塞当前的 goroutine</p><p>案例代码:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>TestTaskControdl</span><span class=p>(</span><span class=nx>t</span> <span class=o>*</span><span class=nx>testing</span><span class=p>.</span><span class=nx>T</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>taskNum</span> <span class=o>:=</span> <span class=mi>5</span>
</span></span><span class=line><span class=cl>    <span class=nx>wg</span> <span class=o>:=</span> <span class=nx>sync</span><span class=p>.</span><span class=nx>WaitGroup</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>    <span class=nx>wg</span><span class=p>.</span><span class=nf>Add</span><span class=p>(</span><span class=nx>taskNum</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=p>&lt;</span> <span class=nx>taskNum</span><span class=p>;</span> <span class=nx>i</span> <span class=o>++</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>go</span> <span class=kd>func</span><span class=p>(</span><span class=nx>i</span> <span class=kt>int</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>defer</span> <span class=nx>wg</span><span class=p>.</span><span class=nf>Done</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;info&#34;</span><span class=p>,</span> <span class=nx>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}(</span><span class=nx>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>wg</span><span class=p>.</span><span class=nf>Wait</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>结论：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>info <span class=m>4</span>
</span></span><span class=line><span class=cl>info <span class=m>3</span>
</span></span><span class=line><span class=cl>info <span class=m>1</span>
</span></span><span class=line><span class=cl>info <span class=m>0</span>
</span></span><span class=line><span class=cl>info <span class=m>2</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=close案例>Close案例<a hidden class=anchor aria-hidden=true href=#close案例>#</a></h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>Test</span><span class=p>(</span><span class=nx>t</span> <span class=o>*</span><span class=nx>testing</span><span class=p>.</span><span class=nx>T</span><span class=p>){</span>
</span></span><span class=line><span class=cl> <span class=nx>test</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kt>int</span><span class=p>,</span> <span class=mi>10</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=k>go</span> <span class=kd>func</span><span class=p>(</span><span class=nx>info</span> <span class=kd>chan</span> <span class=kt>int</span><span class=p>){</span>
</span></span><span class=line><span class=cl> <span class=k>for</span><span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=k>select</span><span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=k>case</span> <span class=nx>val</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=o>&lt;-</span> <span class=nx>test</span><span class=p>:</span>
</span></span><span class=line><span class=cl> <span class=k>if</span> <span class=p>!</span><span class=nx>ok</span><span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=nx>t</span><span class=p>.</span><span class=nf>Logf</span><span class=p>(</span><span class=s>&#34;Channel Closed!&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=k>return</span>
</span></span><span class=line><span class=cl> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=nx>t</span><span class=p>.</span><span class=nf>Logf</span><span class=p>(</span><span class=s>&#34;data %d\n&#34;</span><span class=p>,</span> <span class=nx>val</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}(</span><span class=nx>test</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=k>go</span> <span class=kd>func</span><span class=p>(){</span>
</span></span><span class=line><span class=cl> <span class=nx>test</span> <span class=o>&lt;-</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl> <span class=nx>time</span><span class=p>.</span><span class=nf>Sleep</span><span class=p>(</span><span class=mi>1</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=nx>test</span> <span class=o>&lt;-</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=nb>close</span><span class=p>(</span><span class=nx>test</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=nx>time</span><span class=p>.</span><span class=nf>Sleep</span><span class=p>(</span><span class=mi>5</span> <span class=o>*</span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span> 
</span></span></code></pre></td></tr></table></div></div><p>输出</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>data <span class=m>1</span>
</span></span><span class=line><span class=cl>data <span class=m>2</span>
</span></span><span class=line><span class=cl>Context Closed!
</span></span></code></pre></td></tr></table></div></div><h4 id=单独退出通道>单独退出通道<a hidden class=anchor aria-hidden=true href=#单独退出通道>#</a></h4><p>传输数据不共用一个 channel</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl>   <span class=kd>func</span> <span class=nf>TestA</span><span class=p>(</span><span class=nx>t</span> <span class=o>*</span><span class=nx>testing</span><span class=p>.</span><span class=nx>T</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>test</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kt>int</span><span class=p>,</span> <span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>exit</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kd>struct</span><span class=p>{})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>go</span> <span class=kd>func</span><span class=p>(</span><span class=nx>info</span> <span class=kd>chan</span> <span class=kt>int</span><span class=p>,</span> <span class=nx>exit</span> <span class=kd>chan</span> <span class=kd>struct</span><span class=p>{})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>select</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>case</span> <span class=nx>val</span> <span class=o>:=</span> <span class=o>&lt;-</span><span class=nx>info</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=nx>t</span><span class=p>.</span><span class=nf>Logf</span><span class=p>(</span><span class=s>&#34;data %d\n&#34;</span><span class=p>,</span> <span class=nx>val</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=k>case</span> <span class=o>&lt;-</span><span class=nx>exit</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=nx>t</span><span class=p>.</span><span class=nf>Logf</span><span class=p>(</span><span class=s>&#34;Task Exit!!\n&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}(</span><span class=nx>test</span><span class=p>,</span> <span class=nx>exit</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>go</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>test</span> <span class=o>&lt;-</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=nx>time</span><span class=p>.</span><span class=nf>Sleep</span><span class=p>(</span><span class=mi>1</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>test</span> <span class=o>&lt;-</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>        <span class=nb>close</span><span class=p>(</span><span class=nx>exit</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}()</span>
</span></span><span class=line><span class=cl><span class=nx>time</span><span class=p>.</span><span class=nf>Sleep</span><span class=p>(</span><span class=mi>5</span> <span class=o>*</span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=超时任务控制>超时任务控制<a hidden class=anchor aria-hidden=true href=#超时任务控制>#</a></h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>Test</span><span class=p>(</span><span class=nx>t</span> <span class=o>*</span><span class=nx>testing</span><span class=p>.</span><span class=nx>T</span><span class=p>){</span>
</span></span><span class=line><span class=cl> <span class=nx>test</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kt>int</span><span class=p>,</span> <span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>go</span> <span class=kd>func</span><span class=p>(</span><span class=nx>info</span> <span class=kd>chan</span> <span class=kt>int</span><span class=p>){</span>
</span></span><span class=line><span class=cl> <span class=k>for</span><span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=k>select</span><span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=k>case</span> <span class=nx>val</span> <span class=o>:=</span> <span class=o>&lt;-</span> <span class=nx>info</span><span class=p>:</span>
</span></span><span class=line><span class=cl> <span class=nx>t</span><span class=p>.</span><span class=nf>Logf</span><span class=p>(</span><span class=s>&#34;Data %d\n&#34;</span><span class=p>,</span> <span class=nx>val</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=k>case</span> <span class=o>&lt;-</span> <span class=nx>time</span><span class=p>.</span><span class=nf>After</span><span class=p>(</span><span class=mi>2</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>):</span>
</span></span><span class=line><span class=cl> <span class=nx>t</span><span class=p>.</span><span class=nf>Logf</span><span class=p>(</span><span class=s>&#34;Time out!\n&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=k>return</span>
</span></span><span class=line><span class=cl> <span class=p>}</span>
</span></span><span class=line><span class=cl> <span class=p>}</span>
</span></span><span class=line><span class=cl> <span class=p>}(</span><span class=nx>test</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=k>go</span> <span class=kd>func</span><span class=p>(){</span>
</span></span><span class=line><span class=cl> <span class=nx>test</span> <span class=o>&lt;-</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl> <span class=nx>time</span><span class=p>.</span><span class=nf>Sleep</span><span class=p>(</span><span class=mi>2</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>)</span> <span class=c1>//&gt;=2
</span></span></span><span class=line><span class=cl><span class=c1></span> <span class=nx>test</span> <span class=o>&lt;-</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl> <span class=p>}()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=nx>time</span><span class=p>.</span><span class=nf>Sleep</span><span class=p>(</span><span class=mi>5</span> <span class=o>*</span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>结论:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>main_test.go:98: Data <span class=m>1</span>
</span></span><span class=line><span class=cl>main_test.go:101: Time out!
</span></span></code></pre></td></tr></table></div></div><h4 id=context-的场景>Context 的场景<a hidden class=anchor aria-hidden=true href=#context-的场景>#</a></h4></div><footer class=post-footer><ul class=post-tags><li><a href=https://erica423.github.io/tags/%E6%8A%80%E6%9C%AF/>技术</a></li></ul><nav class=paginav><a class=prev href=https://erica423.github.io/posts/first/><span class=title>« Prev</span><br><span>【完】使用Github Actions实现Hugo静态博客自动部署</span>
</a><a class=next href=https://erica423.github.io/posts/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3map/><span class=title>Next »</span><br><span>深入理解Go sync.Map</span></a></nav></footer><div id=waline></div><script>Waline.init({el:"#waline",dark:"body.dark",serverURL:"https://waline.vercel.app"})</script></article></main><footer class=footer><span>&copy; 2024 <a href=https://erica423.github.io/>Erica-Blog</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span><div class=busuanzi-footer><span id=busuanzi_container_site_pv>本站总访问量<span id=busuanzi_value_site_pv></span>次
</span><span id=busuanzi_container_site_uv>本站访客数<span id=busuanzi_value_site_uv></span>人次</span></div></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>